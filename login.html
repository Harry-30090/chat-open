<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>„É≠„Ç∞„Ç§„É≥ - „ÇØ„É©„Çπ</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#39c6d6" />
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: hsl(199 83% 1%);
        color: hsl(195 100% 93%);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .login-box {
        background: hsl(194 30% 8%);
        border: 1px solid hsl(194 22% 27%);
        border-radius: 1rem;
        padding: 30px;
        width: 320px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        text-align: center;
      }
      h2 {
        color: hsl(193 64% 62%);
        margin-bottom: 20px;
      }
      input {
        width: 100%;
        margin-bottom: 12px;
        padding: 10px;
        border-radius: 0.5rem;
        border: 1px solid hsl(194 22% 27%);
        background: hsl(195 53% 4%);
        color: hsl(195 100% 93%);
      }
      input::placeholder {
        color: hsl(195 20% 68%);
      }
      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 0.75rem;
        background: hsl(193 64% 62%);
        color: white;
        font-weight: bold;
        cursor: pointer;
        margin-top: 5px;
      }
      button:hover {
        background: hsl(193 64% 55%);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transition: opacity 0.2s ease;
      }
      p {
        font-size: 0.9rem;
        margin-top: 10px;
        color: hsl(195 20% 68%);
      }
      .error {
        color: hsl(9 26% 64%);
        font-size: 0.85rem;
        margin-top: 10px;
      }
      #username {
        display: none;
      } /* hidden until register */

      .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        display: inline-block;
        vertical-align: middle;
        margin-right: 6px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="login-box">
      <h2 id="formTitle">„É≠„Ç∞„Ç§„É≥</h2>
      <input id="email" type="email" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" />
      <input id="password" type="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" />
      <input id="username" type="text" placeholder="„É¶„Éº„Ç∂„ÉºÂêçÔºàËãóÂ≠óÔºâ" />
      <div id="agreementContainer" style="display: none; margin-top: 10px">
        <div style="font-size: 14px">
          <input
            type="checkbox"
            id="agreementCheckbox"
            style="vertical-align: middle; margin: 0"
          />
          <span style="margin-left: 3px; vertical-align: middle"
            >Âà©Áî®Ë¶èÁ¥Ñ„Å´ÂêåÊÑè„Åó„Åæ„Åô</span
          >
          <a
            href="/chat-open/tos.html"
            rel="noopener noreferrer"
            id="termsLink"
            style="
              color: #007bff;
              text-decoration: underline;
              margin-left: 5px;
              white-space: nowrap;
              vertical-align: middle;
            "
            >Âà©Áî®Ë¶èÁ¥Ñ„ÇíË¶ã„Çã</a
          >
        </div>
        <p
          id="agreementWarning"
          style="color: red; font-size: 13px; display: none"
        >
          ÂêåÊÑè„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
        </p>
      </div>
      <button id="login">„É≠„Ç∞„Ç§„É≥</button>
      <button id="registerToggle">Êñ∞Ë¶èÁôªÈå≤</button>
      <p id="error" class="error"></p>

    <script>
      // Firebase Init
      const firebaseConfig = {
        apiKey: "AIzaSyAWaL9PudugFC6PmFvORuUgY6ypFD3RiKI",
        authDomain: "open-chat-ece02.firebaseapp.com",
        projectId: "open-chat-ece02",
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      const email = document.getElementById("email");
      const pass = document.getElementById("password");
      const usernameInput = document.getElementById("username");
      const formTitle = document.getElementById("formTitle");
      const errorMsg = document.getElementById("error");
      const loginBtn = document.getElementById("login");
      const registerToggleBtn = document.getElementById("registerToggle");
      const agreementContainer = document.getElementById("agreementContainer");
      const agreementWarning = document.getElementById("agreementWarning");

      const agreementCheckbox = document.getElementById("agreementCheckbox");

      let isRegistering = false;

      // ‚úÖ Enable or disable only in registration mode
      agreementCheckbox.addEventListener("change", () => {
        if (isRegistering) {
          loginBtn.disabled = !agreementCheckbox.checked;
          agreementWarning.style.display = "none";
        }
      });

      // ‚úÖ Check agreement before registering
      loginBtn.addEventListener("click", (e) => {
        if (isRegistering && !agreementCheckbox.checked) {
          e.preventDefault();
          agreementWarning.style.display = "block";
          return;
        }
      });

      function setLoading(isLoading) {
        if (isLoading) {
          loginBtn.disabled = true;
          registerToggleBtn.disabled = true;
          loginBtn.innerHTML = `<span class="spinner"></span>${
            isRegistering ? "ÁôªÈå≤‰∏≠..." : "„É≠„Ç∞„Ç§„É≥‰∏≠..."
          }`;
        } else {
          registerToggleBtn.disabled = false;
          loginBtn.textContent = isRegistering ? "ÁôªÈå≤„Åô„Çã" : "„É≠„Ç∞„Ç§„É≥";

          // ‚úÖ Fix: Only enable if in login mode OR checkbox is checked
          if (isRegistering) {
            loginBtn.disabled = !agreementCheckbox.checked;
          } else {
            loginBtn.disabled = false;
          }
        }
      }

      // Toggle between login/register mode
      registerToggleBtn.onclick = () => {
        isRegistering = !isRegistering;
        if (isRegistering) {
          usernameInput.style.display = "block";
          agreementContainer.style.display = "block";
          formTitle.textContent = "Êñ∞Ë¶èÁôªÈå≤";
          loginBtn.textContent = "ÁôªÈå≤„Åô„Çã";
          registerToggleBtn.textContent = "„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã";
          loginBtn.disabled = true; // start disabled again
        } else {
          usernameInput.style.display = "none";
          agreementContainer.style.display = "none";
          formTitle.textContent = "„É≠„Ç∞„Ç§„É≥";
          loginBtn.textContent = "„É≠„Ç∞„Ç§„É≥";
          registerToggleBtn.textContent = "Êñ∞Ë¶èÁôªÈå≤";
          loginBtn.disabled = false;
        }
        errorMsg.textContent = "";
      };

      // Main button (login or register)
      loginBtn.onclick = async () => {
        errorMsg.textContent = "";
        setLoading(true);
        if (isRegistering) {
          const emailVal = email.value.trim();
          const passVal = pass.value.trim();
          const username = usernameInput.value.trim();

          if (!emailVal || !passVal || !username) {
            errorMsg.textContent = "ÂÖ®„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
            setLoading(false);
            return;
          }

          try {
            // 1Ô∏è‚É£ Create user in Firebase Auth
            const userCred = await auth.createUserWithEmailAndPassword(
              emailVal,
              passVal
            );
            const user = userCred.user;

            // 2Ô∏è‚É£ Update displayName
            await user.updateProfile({ displayName: username });

            // 3Ô∏è‚É£ Save user profile to Firestore
            await db.collection("users").doc(user.uid).set({
              username,
              email: user.email,
              role: "user",
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

            // 4Ô∏è‚É£ Wait and verify it actually saved (with retries)
            let retries = 0;
            let checkDoc;
            while (retries < 10) {
              // Increased to 10 retries = 5 seconds max
              checkDoc = await db.collection("users").doc(user.uid).get();
              if (checkDoc.exists) break;
              await new Promise((r) => setTimeout(r, 500));
              retries++;
            }

            if (!checkDoc.exists) {
              throw new Error("Firestore write failed ‚Äî user doc not found.");
            }

            console.log(
              "‚úÖ User registered and Firestore document saved successfully:",
              username
            );

            // 5Ô∏è‚É£ Redirect only after confirmation
            location.href = "index.html";
          } catch (e) {
            console.error("‚ùå Registration error:", e);
            errorMsg.textContent = e.message;
            setLoading(false);
          }
        } else {
          // üîë Login flow
          try {
            const userCred = await auth.signInWithEmailAndPassword(
              email.value.trim(),
              pass.value.trim()
            );
            const user = userCred.user;

            // üîç Check user data
            const userDoc = await db.collection("users").doc(user.uid).get();
            const data = userDoc.data();

            // üß© If user is banned, check if still active
            if (data && data.role === "banned") {
              const now = new Date();

              // Handle both bannedUntil and banExpires fields safely
              const bannedUntil =
                data.bannedUntil?.toDate?.() || data.banExpires?.toDate?.();

              if (bannedUntil && now > bannedUntil) {
                // ‚úÖ Ban has expired ‚Äî auto unban
                await db.collection("users").doc(user.uid).update({
                  role: "user",
                  bannedUntil: firebase.firestore.FieldValue.delete(),
                  banReason: firebase.firestore.FieldValue.delete(),
                });
                console.log("‚úÖ Ban expired ‚Äî user auto-unbanned:", user.uid);
              } else {
                // üö´ Still banned ‚Äî deny access
                const reason = data.banReason || "‰∏çÊòé„Å™ÁêÜÁî±";
                const until = bannedUntil
                  ? bannedUntil.toLocaleString("ja-JP")
                  : "ÁÑ°ÊúüÈôê";

                await auth.signOut();
                errorMsg.textContent = `„ÅÇ„Å™„Åü„ÅØÂà©Áî®ÂÅúÊ≠¢‰∏≠„Åß„Åô„ÄÇ\nÁêÜÁî±: ${reason}\nÊúüÈôê: ${until}`;
                setLoading(false);
                return;
              }
            }

            // ‚úÖ Only redirect if allowed
            location.href = "index.html";
          } catch (e) {
            console.error("„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:", e);
            errorMsg.textContent = e.message;
            setLoading(false);
          }
        }
      };

      auth.onAuthStateChanged((user) => {});
    </script>
  </body>
</html>
